[gd_scene load_steps=18 format=3 uid="uid://b8girgm16ppp4"]

[ext_resource type="TileSet" uid="uid://8esi5vvvyue7" path="res://Resources/Tilesets/PrimititveTileset.tres" id="1"]
[ext_resource type="PackedScene" uid="uid://66ygb7fkbk5i" path="res://Game Objects/Actors/Players/Rose/Rose.tscn" id="2"]
[ext_resource type="Texture2D" uid="uid://b4omfl7t1ktrt" path="res://Assets/Primitive Tiles/LightGrey/LightGrey_Box32x32.png" id="2_fm3ry"]
[ext_resource type="TileSet" path="res://Resources/Tilesets/Ledges.tres" id="3"]
[ext_resource type="Script" path="res://Scripts/Objects/TileMap/ledge_tilemap_gen.gd" id="4"]
[ext_resource type="PackedScene" uid="uid://dfbmule40f014" path="res://Game Objects/Testing/Cape.tscn" id="5"]
[ext_resource type="Texture2D" uid="uid://cmfubhpbjx123" path="res://Assets/Sprites/Actors/Enemies/Woodeater_Soldier/Woodeater_Soldier_Prototype.png" id="6"]
[ext_resource type="Texture2D" uid="uid://d3qc01yn7toqk" path="res://Assets/Lights/light.png" id="7"]
[ext_resource type="Texture2D" uid="uid://bgjc0dgihi4to" path="res://Assets/Lights/background.png" id="8"]
[ext_resource type="Texture2D" uid="uid://lbs46gau1u64" path="res://Assets/Lights/spot.png" id="9"]
[ext_resource type="Texture2D" uid="uid://bttdv057u2u1c" path="res://Assets/Sprites/Actors/Rose/cape.png" id="10"]
[ext_resource type="Texture2D" uid="uid://uc57t5owk1lq" path="res://Assets/Sprites/Actors/Rose/capetrim.png" id="11"]
[ext_resource type="Script" path="res://Game Objects/Testing/mouse_follow.gd" id="16"]

[sub_resource type="TileSetAtlasSource" id="TileSetAtlasSource_bj7kq"]
texture = ExtResource( "2_fm3ry" )
texture_region_size = Vector2i(32, 32)
0:0/0 = 0
0:0/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:0/0/physics_layer_0/angular_velocity = 0.0
0:0/0/physics_layer_0/polygon_0/points = PackedVector2Array(-16, -16, 16, -16, 16, 16, -16, 16)
0:1/0 = 0
0:1/0/physics_layer_0/linear_velocity = Vector2(0, 0)
0:1/0/physics_layer_0/angular_velocity = 0.0
0:1/0/physics_layer_0/polygon_0/points = PackedVector2Array(-16, -16, 16, -16, 16, 16, -16, 16)
1:0/0 = 0
1:0/0/physics_layer_0/linear_velocity = Vector2(0, 0)
1:0/0/physics_layer_0/angular_velocity = 0.0
1:0/0/physics_layer_0/polygon_0/points = PackedVector2Array(-16, -16, 16, -16, 16, 16, -16, 16)
1:1/0 = 0
1:1/0/physics_layer_0/linear_velocity = Vector2(0, 0)
1:1/0/physics_layer_0/angular_velocity = 0.0
1:1/0/physics_layer_0/polygon_0/points = PackedVector2Array(-16, -16, 16, -16, 16, 16, -16, 16)

[sub_resource type="TileSet" id="TileSet_2dlh4"]
tile_size = Vector2i(32, 32)
physics_layer_0/collision_layer = 1
physics_layer_0/collision_mask = 12
sources/0 = SubResource( "TileSetAtlasSource_bj7kq" )
tile_proxies/source_level = []
tile_proxies/coords_level = []
tile_proxies/alternative_level = []

[sub_resource type="Shader" id="1"]
code = "shader_type canvas_item;

uniform vec2 root_pos = vec2(0,0);
uniform float normfac = 1.0;
uniform float first_stage : hint_range(0.0, 1.0) = 0.5; 
uniform float first_smooth : hint_range(0.0, 1.0) = 0.0; // Lengthens the color transition
uniform float second_stage : hint_range(0.0, 1.0) = 0.0;   // If left at 0, only level 1 is used.
uniform float second_smooth : hint_range(0.0, 1.0) = 0.0;
uniform float min_light : hint_range(0.0, 1.0) = 0.0;
uniform float mid_light : hint_range(0.0, 1.0) = 0.0;
uniform float max_light : hint_range(0.0, 1.0) = 1.0;
uniform float obj_light_add : hint_range(0.0, 1.0) = 0.0;

float light_calc(float light_strength, float would_be_strength) {
	float target_strength = light_strength + would_be_strength * obj_light_add;
	if (target_strength == 0.0) {target_strength = 0.000001;}
	if (would_be_strength == 0.0) {would_be_strength = 1.0;}
	return(target_strength / would_be_strength);
}
void fragment() {
	NORMAL.z = normfac;
}
void light(){
	//LIGHT_COLOR = COLOR;
	LIGHT = COLOR;
}
/*
void light() {
	float level_1 = first_stage;
	float level_1_smooth = first_smooth;
	float level_2 = second_stage;
	float level_2_smooth = second_smooth;
	
	float mid_range_light = mid_light;
	if (mid_light == 0.0) { mid_range_light = max_light * 0.5; }
	vec3 light_normal = normalize(vec3(LIGHT_VEC, -LIGHT_HEIGHT));
	float would_be_strength = max(dot(-light_normal, NORMAL), 0.0);
	if (would_be_strength > level_1 && level_2 == 0.0 ) {
		float diff = smoothstep(level_1, (level_1 + level_1_smooth), would_be_strength) + min_light;
		if (diff >= max_light) {diff = max_light;}
		LIGHT *= light_calc(diff, would_be_strength);
	} else if (would_be_strength > level_1 && would_be_strength < level_2 && level_2 != 0.0 ) {
		float diff = smoothstep(level_1, (level_1 + level_1_smooth), would_be_strength) + min_light;
		if (diff >= mid_range_light ) {diff = mid_range_light;}
		LIGHT *= light_calc(diff, would_be_strength);
	} else if (would_be_strength >= level_2 && level_2 != 0.0 ) {
		float diff = smoothstep(level_2, (level_2 + level_2_smooth), would_be_strength) + mid_range_light;
		if (diff < mid_range_light ) {diff = mid_range_light;}
		if (diff >= max_light) {diff = max_light;}
		LIGHT *= light_calc(diff, would_be_strength);
	} else { 
		if (min_light != 0.0) { 
			LIGHT_VEC = -NORMAL.xy*length(LIGHT_VEC); 
		}
		LIGHT *= min_light;   
		                                                                                                                               
	}
}
*/
/*
uniform sampler2D norm;
uniform float theta = 0.0;
uniform vec2 root_pos = vec2(0,0);

void fragment() {
	NORMAL = vec3(0, 0, sign(root_pos.y - FRAGCOORD.y) * 2.0 );
	
	// Get the vertex color or the color from the texture if set
	vec4 finalColor = min(texture(TEXTURE, UV), COLOR);
	COLOR = finalColor;
}


void light()
{
	//float tempx = LIGHT_VEC.x;
	//float tempy = -LIGHT_VEC.y;
	//LIGHT_VEC.x = tempx * cos(theta) - tempy * sin(theta);
	//LIGHT_VEC.y = tempx * sin(theta) + tempy * cos(theta);
	LIGHT = COLOR;
	SHADOW_COLOR = vec4(83, 31, 31, 255);
}
*/"

[sub_resource type="ShaderMaterial" id="2"]
shader = SubResource( "1" )
shader_param/root_pos = Vector2(0, 0)
shader_param/normfac = 17.625
shader_param/first_stage = 0.0
shader_param/first_smooth = 0.0
shader_param/second_stage = 0.0
shader_param/second_smooth = 0.0
shader_param/min_light = 0.0
shader_param/mid_light = 0.0
shader_param/max_light = 0.805
shader_param/obj_light_add = 0.0

[node name="TestRoom" type="Node2D"]
script = null

[node name="Sprite" type="Sprite2D" parent="."]
modulate = Color(0.27451, 0.27451, 0.27451, 1)
light_mask = 2
scale = Vector2(20, 20)
texture = ExtResource( "8" )
script = null

[node name="CanvasModulate" type="CanvasModulate" parent="."]
visible = false
color = Color(0.496094, 0.496094, 0.496094, 1)
script = null

[node name="TileMap2" type="TileMap" parent="."]
skew = 4.37114e-08
tile_set = SubResource( "TileSet_2dlh4" )
collision_visibility_mode = 1
format = 2
layer_0/tile_data = PackedInt32Array(131070, 0, 0, 131071, 0, 0, 65536, 0, 0, 65537, 0, 0, 65538, 0, 0, 65539, 0, 0)
script = null

[node name="TileMap" type="TileMap" parent="."]
visible = false
position = Vector2(430, 2)
tile_set = ExtResource( "1" )
cell_quadrant_size = 32
collision_visibility_mode = 1
format = 2
layer_0/tile_data = PackedInt32Array(196554, 0, 0, 196555, 0, 0, 196556, 0, 0, 196557, 0, 0, 196558, 0, 0, 196559, 0, 0, 196560, 0, 0, 196561, 0, 0, 196562, 0, 0, 196563, 0, 0, 196564, 0, 0, 196565, 0, 0, 196566, 0, 0, 196567, 0, 0, 196568, 0, 0, 196569, 0, 0, 196570, 0, 0, 196571, 0, 0, 196572, 0, 0, 196573, 0, 0, 196574, 0, 0, 196575, 0, 0, 196576, 0, 0, 196577, 0, 0, 196578, 0, 0, 196579, 0, 0, 196580, 0, 0, 196581, 0, 0, 131046, 4, 0, 196582, 0, 0, 131047, 65540, 0, 196583, 0, 0, 131048, 131076, 0, 196584, 0, 0, 131049, 196612, 0, 196585, 0, 0, 196586, 0, 0, 196587, 0, 0, 131052, 3, 0, 196588, 0, 0, 131053, 65539, 0, 196589, 0, 0, 131054, 131075, 0, 196590, 0, 0, 196591, 0, 0, 196592, 0, 0, 196595, 0, 0, 196596, 0, 0, 196597, 0, 0, 196598, 0, 0, 196599, 0, 0, -327684, 0, 0, -196612, 0, 0, -65540, 0, 0, -262145, 0, 0, -131073, 0, 0, 131077, 0, 0, 131078, 0, 0, 131079, 0, 0, 131080, 0, 0, 131081, 0, 0, 131082, 0, 0, 131083, 0, 0, 131084, 0, 0, 131085, 0, 0, 131086, 0, 0, 131087, 0, 0, 131088, 0, 0, 131089, 0, 0, 131090, 0, 0, 131091, 0, 0, 131092, 0, 0, 131093, 0, 0, 131094, 0, 0, 131095, 0, 0, 131096, 0, 0, 131097, 0, 0, 131098, 0, 0, 131099, 0, 0, 131100, 0, 0, 131101, 0, 0, 131102, 0, 0, 131103, 0, 0, 131104, 0, 0, 131105, 0, 0, 131106, 0, 0, 131107, 0, 0, 131108, 0, 0, 131109, 0, 0, 131110, 0, 0, 131111, 0, 0, 131112, 0, 0, 131113, 0, 0, 131114, 0, 0, 131115, 0, 0, 131116, 0, 0, 131117, 0, 0, 131118, 0, 0, 131119, 0, 0, 131120, 0, 0, 131121, 0, 0, 131122, 0, 0, 131123, 0, 0, 131124, 0, 0, 131125, 0, 0, 131126, 0, 0, 131127, 0, 0, 131128, 0, 0, 131129, 0, 0, 131130, 0, 0, 131131, 0, 0, 131132, 0, 0, 131133, 0, 0, 131134, 0, 0, 131135, 0, 0, 131136, 0, 0, 131137, 0, 0, 131138, 0, 0, 131139, 0, 0, 131140, 0, 0, 131141, 0, 0, 131142, 0, 0, 131143, 0, 0, 131144, 0, 0, 131145, 0, 0, 131146, 0, 0, 131147, 0, 0, 131148, 0, 0, 131149, 0, 0, 131150, 0, 0, 131151, 0, 0, 131152, 0, 0, 131153, 0, 0, 131154, 0, 0, 131155, 0, 0, 131156, 0, 0, 131157, 0, 0, 131158, 0, 0, 131159, 0, 0, 131160, 0, 0, 131161, 0, 0, 131162, 0, 0, 131163, 0, 0, 131164, 0, 0, 131165, 0, 0, 131166, 0, 0, 131167, 0, 0, 131168, 0, 0, 131169, 0, 0, 131170, 0, 0, 131171, 0, 0, 131172, 0, 0, 131173, 0, 0, 131174, 0, 0, 131175, 0, 0, 131176, 0, 0, 131177, 0, 0, 131178, 0, 0, 131179, 0, 0, 131180, 0, 0, 131181, 0, 0, 131182, 0, 0, 131183, 0, 0, 131184, 0, 0, 131185, 0, 0, 131186, 0, 0, 131187, 0, 0, 131188, 0, 0, 131189, 0, 0, 131190, 0, 0, 131191, 0, 0, 131192, 0, 0, 131193, 0, 0, 131194, 0, 0, 131195, 0, 0, 131196, 0, 0, 131197, 0, 0, 131198, 0, 0, 131199, 0, 0, 131200, 0, 0, 131201, 0, 0, 131202, 0, 0, 131203, 0, 0, 131204, 0, 0, 131205, 0, 0, 131206, 0, 0, 131207, 0, 0, 131208, 0, 0, 131209, 0, 0, 131210, 0, 0, 131211, 0, 0, 131212, 0, 0, 131213, 0, 0, 131214, 0, 0)
script = null

[node name="Ledges" type="TileMap" parent="TileMap"]
visible = false
z_index = -1
tile_set = ExtResource( "3" )
format = 2
script = ExtResource( "4" )

[node name="Rose" parent="." instance=ExtResource( "2" )]
position = Vector2(51, -10)
move_states = {
"action": NodePath("MoveStates/Action"),
"hit": NodePath("MoveStates/Hit"),
"ledge_grab": NodePath("MoveStates/LedgeGrab"),
"move_in_air": NodePath("MoveStates/MoveInAir"),
"move_on_ground": NodePath("MoveStates/MoveOnGround")
}

[node name="BaseAnimator" parent="Rose/Animators" index="0"]
blend_times = []

[node name="ShaderAnimator" parent="Rose/Animators" index="1"]
blend_times = []

[node name="Cape" parent="." instance=ExtResource( "5" )]
material = SubResource( "2" )
z_index = 5
phys_obj_path = NodePath("../Rose")
targets_path = NodePath("../Rose/Utilities/CapeTarget")
influencers_path = NodePath("../Rose/Utilities/CapeInfluencers")
wind_path = NodePath("../Rose/Utilities/WindNode")
texture = ExtResource( "10" )
trim_texture = ExtResource( "11" )

[node name="Woodeater_Soldier_Prototype" type="Sprite2D" parent="."]
position = Vector2(-71, 25)
texture = ExtResource( "6" )
script = null

[node name="Light2D" type="PointLight2D" parent="."]
position = Vector2(281, -258)
z_index = 4
range_item_cull_mask = 2
shadow_item_cull_mask = 2
texture = ExtResource( "7" )
script = ExtResource( "16" )
speed = 0.0

[node name="Sprite" type="Sprite2D" parent="Light2D"]
texture = ExtResource( "9" )
script = null

[editable path="Rose"]
